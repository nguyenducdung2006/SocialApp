<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang ch·ªß - Social App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/css/home.css}">
</head>

<!-- D√πng data-homebg thay th:style ƒë·ªÉ tr√°nh l·ªói SpEL 100k chars -->

<body th:attr="data-homebg=${sessionUser != null and sessionUser.equippedHomeBg != null ?
    sessionUser.equippedHomeBg : ''}">

    <!-- Overlay m·ªù khi c√≥ n·ªÅn ‚Äî JS s·∫Ω b·∫≠t l√™n n·∫øu c√≥ BG -->
    <div id="homeBgOverlay"
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:0;pointer-events:none;"></div>

    <!-- B·ªçc to√†n b·ªô content -->
    <div style="position:relative;z-index:1;">

        <!-- NAVBAR -->
        <nav class="top-navbar">
            <a class="brand" th:href="@{/home}">‚ú¶ SocialApp</a>
            <div class="search-wrap d-none d-md-flex">
                <form th:action="@{/search}" method="get" class="w-100 position-relative">
                    <i class="bi bi-search"></i>
                    <input type="text" name="q" class="search-input" placeholder="T√¨m ki·∫øm t√°c ph·∫©m, ng∆∞·ªùi d√πng...">
                </form>
            </div>
            <div class="nav-spacer"></div>
            <div class="d-flex align-items-center gap-2">
                <a th:href="@{/notifications}" class="nav-icon text-decoration-none">
                    <i class="bi bi-bell"></i>
                    <span class="notif-badge">3</span>
                </a>
                <a th:href="@{/chat}" class="nav-icon text-decoration-none">
                    <i class="bi bi-chat-dots"></i>
                    <span class="notif-badge">5</span>
                </a>
                <a th:href="@{/upload}" class="upload-btn text-decoration-none">
                    <i class="bi bi-cloud-upload"></i> ƒêƒÉng t·∫£i
                </a>
                <a th:href="@{/profile}" class="text-decoration-none">
                    <div class="avatar-nav" th:if="${sessionUser != null and sessionUser.avatarData != null}"
                        style="overflow:hidden;padding:0;">
                        <img th:src="@{/profile/avatar/{id}(id=${sessionUser.id})}"
                            style="width:100%;height:100%;border-radius:50%;object-fit:cover;" alt="avatar">
                    </div>
                    <div class="avatar-nav" th:if="${sessionUser == null or sessionUser.avatarData == null}"
                        th:text="${sessionUser != null ? sessionUser.username.substring(0,1).toUpperCase() : 'U'}">U
                    </div>
                </a>
                <a th:href="@{/wallet/recharge}" class="nav-icon text-decoration-none" title="N·∫°p ti·ªÅn">
                    <i class="bi bi-wallet2"></i>
                </a>
                <a th:href="@{/auth/logout}" class="nav-icon text-decoration-none" title="ƒêƒÉng xu·∫•t">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </nav>

        <!-- TAB BAR -->
        <div class="tab-bar">
            <a href="#" data-target="new" class="tab-link feed-tab active">M·ªõi nh·∫•t</a>
            <a href="#" data-target="following" class="tab-link feed-tab">ƒêang theo d√µi</a>
            <a href="#" data-target="popular" class="tab-link feed-tab">Ph·ªï bi·∫øn</a>
            <a href="#" data-target="ranking" class="tab-link feed-tab">Ranking</a>
        </div>

        <!-- MAIN LAYOUT -->
        <div class="page-layout">

            <!-- LEFT SIDEBAR -->
            <div class="left-sidebar d-none d-xl-block">
                <div class="sidebar-section">
                    <div class="sidebar-label">Kh√°m ph√°</div>
                    <a th:href="@{/home}" class="sidebar-link active">
                        <i class="bi bi-house-fill"></i> Trang ch·ªß
                    </a>
                    <a th:href="@{/trending}" class="sidebar-link">
                        <i class="bi bi-fire"></i> Xu h∆∞·ªõng
                    </a>
                    <a th:href="@{/settings}" class="sidebar-link">
                        <i class="bi bi-gear-fill"></i> C√†i ƒë·∫∑t
                    </a>
                    <a th:href="@{/saved}" class="sidebar-link">
                        <i class="bi bi-bookmark-fill"></i> ƒê√£ l∆∞u
                    </a>
                    <a th:href="@{/liked}" class="sidebar-link">
                        <i class="bi bi-heart-fill"></i> Y√™u th√≠ch
                    </a>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-label">Tags ph·ªï bi·∫øn</div>
                    <div class="tag-list">
                        <a th:href="@{/search(q=${tag})}" th:each="tag : ${hotTags}" class="text-decoration-none">
                            <span class="tag" th:text="${tag}">#tag</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <div class="sec-header">
                    <span class="sec-title">‚ú® M·ªõi nh·∫•t h√¥m nay</span>
                    <a th:href="@{/home?tab=new}" class="sec-all">Xem t·∫•t c·∫£ ‚Üí</a>
                </div>
                <div class="img-grid" id="mainGrid">
                    <!-- B√†i vi·∫øt ƒë∆∞·ª£c t·∫£i b·∫±ng AJAX qua home.js -->
                </div>


                <div class="text-center mb-4">
                    <button class="load-more-btn" id="loadMoreBtn">
                        <i class="bi bi-arrow-clockwise me-2"></i>T·∫£i th√™m
                    </button>
                </div>

                <!-- RANKING -->
                <div class="sec-header">
                    <span class="sec-title">üèÜ Ranking h√¥m nay</span>
                    <a th:href="@{/ranking}" class="sec-all">Xem t·∫•t c·∫£ ‚Üí</a>
                </div>
                <div class="ranking-grid">
                    <div class="rank-card" th:each="r, stat : ${rankingPosts}">
                        <span th:class="'rank-num r' + ${stat.count}" th:text="${stat.count}">1</span>
                        <a th:href="@{/post/{id}(id=${r.id})}">
                            <img th:if="${r.imageData != null}" th:src="@{/upload/image/{id}(id=${r.id})}"
                                class="rank-img" alt="">
                            <img th:if="${r.imageData == null && r.imageUrl != null}" th:src="${r.imageUrl}"
                                class="rank-img" alt="">
                        </a>
                        <div class="rank-info">
                            <a th:href="@{/post/{id}(id=${r.id})}" class="text-decoration-none text-light">
                                <div class="rank-title" th:text="${r.title}">Ti√™u ƒë·ªÅ</div>
                            </a>
                            <a th:href="@{/profile/view/{id}(id=${r.user.id})}" class="text-decoration-none text-muted">
                                <div class="rank-author" th:text="'@' + ${r.user.username}">@user</div>
                            </a>
                        </div>
                        <span class="rank-likes"><i class="bi bi-heart-fill"></i> <span
                                th:text="${r.likesCount}">0</span></span>
                    </div>
                </div>
            </div>

            <!-- RIGHT SIDEBAR -->
            <div class="right-sidebar d-none d-lg-block">
                <div class="widget">
                    <a th:href="@{/profile}" class="text-decoration-none">
                        <div class="profile-top">
                            <div class="profile-avatar"
                                th:if="${sessionUser != null and sessionUser.avatarData != null}"
                                style="overflow:hidden;padding:0;">
                                <img th:src="@{/profile/avatar/{id}(id=${sessionUser.id})}"
                                    style="width:100%;height:100%;object-fit:cover;border-radius:50%;" alt="avatar">
                            </div>
                            <div class="profile-avatar" th:if="${sessionUser == null or sessionUser.avatarData == null}"
                                th:text="${sessionUser != null ? sessionUser.username.substring(0,1).toUpperCase() : 'U'}">
                                U</div>
                            <div class="profile-name"
                                th:text="${sessionUser != null ? (sessionUser.fullName != null ? sessionUser.fullName : sessionUser.username) : 'Ng∆∞·ªùi d√πng'}">
                                Ng∆∞·ªùi d√πng</div>
                            <div class="profile-username"
                                th:text="${sessionUser != null ? '@' + sessionUser.username : '@username'}">@username
                            </div>
                        </div>
                    </a>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-num" th:text="${totalPosts != null ? totalPosts : 0}">0</div>
                            <div class="stat-label">T√°c ph·∫©m</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-num" th:text="${totalFollowers != null ? totalFollowers : 0}">0</div>
                            <div class="stat-label">Followers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-num" th:text="${totalFollowing != null ? totalFollowing : 0}">0</div>
                            <div class="stat-label">Following</div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                        <a th:href="@{/shop}" class="btn btn-sm btn-outline-warning w-50">
                            <i class="bi bi-shop"></i> Shop
                        </a>
                        <a th:href="@{/wallet/recharge}" class="btn btn-sm btn-outline-success w-50">
                            <i class="bi bi-wallet2"></i> N·∫°p ti·ªÅn
                        </a>
                    </div>
                </div>

                <div class="widget">
                    <div class="widget-title">G·ª£i √Ω theo d√µi</div>
                    <div class="suggest-list">
                        <div class="suggest-item" th:each="u : ${suggestedUsers}">
                            <a th:href="@{/profile/view/{id}(id=${u.id})}" class="text-decoration-none">
                                <div class="suggest-avatar text-white d-flex align-items-center justify-content-center"
                                    th:if="${u.avatarData == null}" style="background:#e94560;"
                                    th:text="${u.username.substring(0,1).toUpperCase()}">A</div>
                                <img th:if="${u.avatarData != null}" th:src="@{/profile/avatar/{id}(id=${u.id})}"
                                    class="suggest-avatar border-0" style="object-fit:cover;" alt="A">
                            </a>
                            <div class="suggest-info text-truncate">
                                <a th:href="@{/profile/view/{id}(id=${u.id})}" class="text-decoration-none text-light">
                                    <div class="suggest-name text-truncate"
                                        th:text="${u.fullName != null ? u.fullName : u.username}">Name</div>
                                </a>
                                <div class="suggest-sub text-truncate" th:text="'@' + ${u.username}">@user</div>
                            </div>
                            <button class="follow-btn quick-follow-btn" th:data-id="${u.id}">Theo d√µi</button>
                        </div>
                        <div th:if="${suggestedUsers == null or suggestedUsers.empty}"
                            class="text-muted text-center py-3">
                            <small>Ch∆∞a c√≥ g·ª£i √Ω</small>
                        </div>
                    </div>
                </div>

                <div class="widget">
                    <div class="widget-title">Tags hot h√¥m nay</div>
                    <div class="tag-list">
                        <a th:href="@{/search(q=${tag})}" th:each="tag : ${hotTags}" class="text-decoration-none">
                            <span class="tag" th:text="${tag}">#tag</span>
                        </a>
                        <div th:if="${hotTags == null or hotTags.empty}" class="text-muted text-center w-100 py-3">
                            <small>ƒêang tr·ªëng</small>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- end page-layout -->

        <!-- LIGHTBOX -->
        <div class="lightbox" id="lightbox">
            <div class="lightbox-close" id="lightboxClose"><i class="bi bi-x-lg"></i></div>
            <img src="" id="lightboxImg" alt="">
        </div>

    </div><!-- end z-index wrapper -->

    <!-- Script background & Quick Follow JS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bgUrl = document.body.getAttribute('data-homebg');
            if (bgUrl && bgUrl.trim() !== '') {
                document.body.style.background = `url('${bgUrl}') no-repeat center center fixed`;
                document.body.style.backgroundSize = 'cover';
                document.getElementById('homeBgOverlay').style.display = 'block';
            }

            // Quick follow handler
            document.querySelectorAll('.quick-follow-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const userId = this.getAttribute('data-id');
                    fetch('/profile/follow/' + userId, {
                        method: 'POST'
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            if (data.followed) {
                                this.innerText = 'ƒê√£ theo d√µi';
                                this.style.background = '#444';
                                this.style.color = '#fff';
                                this.style.border = 'none';
                            } else {
                                this.innerText = 'Theo d√µi';
                                this.style.background = 'transparent';
                                this.style.color = 'var(--primary)';
                                this.style.border = '1px solid var(--primary)';
                            }
                        })
                        .catch(e => console.error(e));
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/home.js}"></script>
</body>

</html>